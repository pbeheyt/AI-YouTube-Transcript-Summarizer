chrome.tabs.onUpdated.addListener((async(e,t,a)=>{if("complete"===t.status&&a.url)try{const t=await fetch(chrome.runtime.getURL("config.json")),c=(await t.json(),await chrome.storage.local.get(["aiTabId","scriptInjected","useClaudeAI"]));if(console.log("Tab updated:",a.url),console.log("Checking tab:",e,"against aiTabId:",c.aiTabId),console.log("URL includes claude.ai:",a.url.includes("claude.ai")),e===c.aiTabId&&!c.scriptInjected&&(c.useClaudeAI&&a.url.includes("claude.ai")||!c.useClaudeAI&&a.url.includes("chatgpt.com"))){const t=c.useClaudeAI?"dist/claude-content.bundle.js":"dist/gpt-content.bundle.js";console.log("Attempting to inject script:",t);try{await chrome.scripting.executeScript({target:{tabId:e},files:[t]}),console.log("✅ Script injection successful"),await chrome.storage.local.set({scriptInjected:!0})}catch(e){console.error("❌ Script injection failed:",e)}}}catch(e){console.error("Error:",e)}})),chrome.runtime.onInstalled.addListener((async()=>{const e={useClaudeAI:!0,selectedPromptType:"academic"},t=await chrome.storage.local.get(Object.keys(e)),a={};for(const[c,o]of Object.entries(e))void 0===t[c]&&(a[c]=o);Object.keys(a).length>0&&await chrome.storage.local.set(a)})),chrome.runtime.onInstalled.addListener((()=>{chrome.contextMenus.create({id:"summarizeYouTubeVideo",title:"Summarize this YouTube Video",contexts:["page"],documentUrlPatterns:["*://*.youtube.com/watch?*"]})})),chrome.contextMenus.onClicked.addListener((async(e,t)=>{if("summarizeYouTubeVideo"===e.menuItemId)try{chrome.tabs.sendMessage(t.id,{action:"extractTranscript"});const{useClaudeAI:e,selectedPromptType:a}=await chrome.storage.local.get(["useClaudeAI","selectedPromptType"]),c=await fetch(chrome.runtime.getURL("config.json")),o=await c.json(),r=await chrome.storage.local.get(["useClaudeAI","selectedPromptType"]);await chrome.storage.local.clear(),await chrome.storage.local.set(r);const s=e?o.claudeUrl:o.chatgptUrl,i=o.prompts[a]||o.prompts.academic,l=await chrome.tabs.create({url:s,active:!1});await chrome.storage.local.set({aiTabId:l.id,scriptInjected:!1,useClaudeAI:e,prePrompt:i}),await chrome.tabs.update(l.id,{active:!0})}catch(e){console.error("Error during YouTube summarization:",e)}}));