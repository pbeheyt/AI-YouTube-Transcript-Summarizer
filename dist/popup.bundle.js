document.addEventListener("DOMContentLoaded",(async()=>{const e=document.getElementById("promptType"),t=document.getElementById("summarizeBtn"),o=document.getElementById("statusMessage"),{selectedPromptType:r}=await chrome.storage.local.get(["selectedPromptType"]);r&&(e.value=r),e.addEventListener("change",(()=>{chrome.storage.local.set({selectedPromptType:e.value})}));const a=e=>new Promise((t=>{try{chrome.tabs.sendMessage(e,{action:"ping"},(e=>{chrome.runtime.lastError?(console.log("Content script not ready:",chrome.runtime.lastError),t(!1)):(console.log("Content script is ready, received:",e),t(!0))}))}catch(e){console.error("Error checking content script:",e),t(!1)}}));t.addEventListener("click",(async()=>{try{const r=(await chrome.tabs.query({active:!0,currentWindow:!0}))[0];if(!r.url.includes("youtube.com/watch"))return o.textContent="Not a YouTube video page. Please navigate to a video.",void(o.style.color="#ff6b6b");o.textContent="Checking connection to page...",o.style.color="#ccc",t.disabled=!0;let n=await a(r.id);if(n||(o.textContent="Initializing transcript extractor...",await(async e=>{try{return console.log("Attempting to inject content script manually..."),await chrome.scripting.executeScript({target:{tabId:e},files:["dist/youtube-content.bundle.js"]}),!0}catch(e){return console.error("Failed to inject content script:",e),!1}})(r.id)&&(await new Promise((e=>setTimeout(e,1e3))),n=await a(r.id))),!n)return o.textContent="Failed to connect to YouTube page. Please refresh the page and try again.",o.style.color="#ff6b6b",void(t.disabled=!1);o.textContent="Extracting transcript...";const c=e.value,i={selectedPromptType:c};await chrome.storage.local.clear(),await chrome.storage.local.set(i),chrome.tabs.sendMessage(r.id,{action:"extractTranscript"},(e=>{if(chrome.runtime.lastError)return console.error("Error sending extractTranscript command:",chrome.runtime.lastError),o.textContent="Communication error. Please refresh the page and try again.",o.style.color="#ff6b6b",void(t.disabled=!1);console.log("Extract transcript command sent, response:",e)}));let s=!1,l=0;const d=15;for(;!s&&l<d;){await new Promise((e=>setTimeout(e,1e3)));const{youtubeVideoData:e}=await chrome.storage.local.get(["youtubeVideoData"]);if(e){if(s=!0,e.error)return o.textContent=e.message||"Failed to extract transcript",o.style.color="#ff6b6b",void(t.disabled=!1);const r=await fetch(chrome.runtime.getURL("config.json")),a=await r.json(),n=a.claudeUrl,i=a.prompts[c]||a.prompts.academic,l=await chrome.tabs.create({url:n,active:!1});await chrome.storage.local.set({aiTabId:l.id,scriptInjected:!1,prePrompt:i}),await chrome.tabs.update(l.id,{active:!0}),window.close()}else l++}s||(o.textContent="Timeout: Failed to extract transcript. Please try again.",o.style.color="#ff6b6b",t.disabled=!1)}catch(e){console.error("Error:",e),o.textContent=`Error: ${e.message||"Unknown error occurred"}`,o.style.color="#ff6b6b",t.disabled=!1}})),(async()=>{try{(await chrome.tabs.query({active:!0,currentWindow:!0}))[0].url.includes("youtube.com/watch")?(t.disabled=!1,o.textContent="Ready to summarize",o.style.color="#4caf50"):(t.disabled=!0,o.textContent="Please navigate to a YouTube video page",o.style.color="#ff6b6b")}catch(e){console.error("Error checking page:",e)}})()}));